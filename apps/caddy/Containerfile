# renovate: datasource=github-releases packageName=caddyserver/caddy
ARG CADDY_VERSION=2.10.2

FROM caddy:${CADDY_VERSION}-builder AS builder

# renovate: datasource=github-tags packageName=caddy-dns/cloudflare
ARG CADDY_DNS_CLOUDFLARE_VERSION=0.2.2
# renovate: datasource=github-tags packageName=greenpau/caddy-security
ARG CADDY_SECURITY_VERSION=1.1.31

RUN xcaddy build \
    --with github.com/caddy-dns/cloudflare@v${CADDY_DNS_CLOUDFLARE_VERSION} \
    --with github.com/greenpau/caddy-security@v${CADDY_SECURITY_VERSION} \
    --with github.com/WeidiDeng/caddy-cloudflare-ip

FROM gcr.io/distroless/static-debian13:nonroot@sha256:01e550fdb7ab79ee7be5ff440a563a58f1fd000ad9e0c532e65c3d23f917f1c5 AS final

COPY --from=builder /usr/bin/caddy /usr/bin/caddy

CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
