# renovate: datasource=github-releases packageName=caddyserver/caddy
ARG CADDY_VERSION=2.10.2

FROM caddy:${CADDY_VERSION}-builder AS builder

# renovate: datasource=github-tags packageName=caddy-dns/cloudflare
ARG CADDY_DNS_CLOUDFLARE_VERSION=0.2.3
# renovate: datasource=github-tags packageName=greenpau/caddy-security
ARG CADDY_SECURITY_VERSION=1.1.31

RUN xcaddy build \
    --with github.com/caddy-dns/cloudflare@v${CADDY_DNS_CLOUDFLARE_VERSION} \
    --with github.com/greenpau/caddy-security@v${CADDY_SECURITY_VERSION} \
    --with github.com/WeidiDeng/caddy-cloudflare-ip

FROM gcr.io/distroless/static-debian13:nonroot@sha256:f9f84bd968430d7d35e8e6d55c40efb0b980829ec42920a49e60e65eac0d83fc AS final

COPY --from=builder /usr/bin/caddy /usr/bin/caddy

CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
